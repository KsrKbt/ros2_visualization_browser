# ros2_visualization_browser
# システム概要：Zenohを用いたROS 2リアルタイム可視化アプリ

本システムは、ROS 2で動作するロボット（TurtleBot3）とCartographer SLAMから得られるデータを、Webブラウザ上でリアルタイムに可視化するアプリケーションです。中核技術としてZenohプロトコルを採用し、高いパフォーマンスとネットワーク環境への柔軟な対応を実現しています。

## 1\. データの流れ（データフロー）

システムのデータは、ロボットでの発生からブラウザでの表示まで、以下の5つのステージを経て流れます。

```
[ROS 2] -> [Zenohブリッジ] -> [バックエンド(Python)] -> [フロントエンド(JS)] -> [ブラウザ表示]
```

### ステージ1：データ発生源 (ROS 2)

  * **役割**: TurtleBot3とCartographerが地図作成と自己位置推定を行います。
  * **データ**:
      * `/map`: 地図データ (`nav_msgs/OccupancyGrid`)
      * `/tf`, `/tf_static`: 座標変換データ (`tf2_msgs/TFMessage`)
  * **アクション**: 上記トピックをROS 2の標準プロトコルである**DDS**でネットワークに配信します。

### ステージ2：プロトコル変換 (Zenoh Bridge)

  * **役割**: `zenoh-bridge-dds`が、DDSとZenohプロトコル間の「翻訳機」として動作します。
  * **アクション**: DDSで配信されたトピックを購読し、Zenohプロトコルに変換してZenohネットワーク上に再配信します。
      * (例) ROSトピック `/map` → Zenohキー `map`

### ステージ3：データ処理と中継 (バックエンド / `main.py`)

  * **役割**: Zenohからデータを受け取り、Webで表示可能な形式に加工・中継する中央処理ハブです。
  * **アクション**:
    1.  **受信**: Zenohクライアントとして`map`や`tf`キーを購読します。
    2.  **地図加工**: 受信した`map`データを、RViz風の配色（障害物確率に応じたグレースケール）を持つ画像データに変換します。
    3.  **位置計算**: 受信した`tf`データから、地図座標系におけるロボットの正確な位置と向き`(x, y, yaw)`を計算します。
    4.  **送信**: 加工した地図画像と、ロボットの位置・向き情報を、接続している全ブラウザに**WebSocket**経由で送信します。

### ステージ4：描画データの受信 (フロントエンド / `static/main.js`)

  * **役割**: バックエンドから送られてくる描画用データを受け取ります。
  * **アクション**: WebSocket経由で`map`（画像）と`pose`（JSON）メッセージを受信し、描画の準備をします。

### ステージ5：最終的な可視化 (ブラウザ / Canvas)

  * **役割**: 受け取ったデータを元に、ユーザーが目にする最終的な地図とロボットを描画します。
  * **アクション**:
    1.  **拡大描画**: 小さな地図画像を、指定した倍率でHTMLの`<canvas>`要素全体に拡大して描画します。
    2.  **くっきり表示**: CSSの`image-rendering: pixelated;`設定により、拡大表示時に画像がぼやけず、マス目が鮮明に表示されます。
    3.  **ロボット描画**: 地図の原点・解像度・倍率を考慮してロボットのピクセル位置を計算し、三角形を描画します。
    4.  **向きと反転**: ロボットの向きに合わせて三角形を回転させ、最後にCSSの`transform: scaleX(-1);`でキャンバス全体を左右反転させることで、最終的な見た目を完成させます。

-----

## 2\. なぜZenohを使うのか？

本システムで、`ros2-web-bridge`や`ROS_DOMAIN_ID`の共有といった他の方法ではなく、Zenohを採用したのには明確な理由があります。

### ネットワークの透過性と安定性

これがZenohを採用する**最大のメリット**です。ROS 2の標準通信(DDS)は、Wi-Fiや異なるネットワークセグメント、インターネットなどを経由すると、ノード間の自動検出（マルチキャスト）が失敗し、接続が非常に不安定になります。

Zenohは、特定のIPアドレス（ルーターまたはブリッジ）に対してTCPで接続するため、このようなネットワークの制約を容易に克服できます。これにより、**有線LAN以外の不安定な環境でも、安定したデータ送受信が可能**になります。

### 高いパフォーマンスと効率性

`ros2-web-bridge`がROSメッセージを低速なJSON（テキスト）に変換するのに対し、Zenohは**高効率な独自のバイナリ形式**で通信します。これにより、`/tf`のような高頻度トピックや`/map`のような大容量トピックを、低遅延かつ少ないネットワーク負荷で転送できます。

### 比較表

| 比較項目 | **Zenoh (今回採用)** | `ros2-web-bridge` | `ROS_DOMAIN_ID`共有 |
| :--- | :--- | :--- | :--- |
| **通信性能** | ◎ (高効率バイナリ) | △ (JSON変換の負荷) | ◎ (ネイティブ) |
| **ネットワーク柔軟性** | ◎ (インターネット越えが容易) | ◯ (TCPベースで比較的容易) | ✕ (LAN内に限定されがち) |
| **安定性・堅牢性** | ◎ (単一接続で確実) | ◯ | △ (マルチキャストに依存し不安定) |

### まとめ

以上の理由から、Zenohは、現実世界の様々なネットワーク環境下でロボティクスシステムを外部アプリケーションと連携させる上で、**パフォーマンス・安定性・柔軟性の全てを高いレベルで満たす、非常に優れた現代的なソリューション**であると言えます。